// sync-seminar.js
import { Client } from "@notionhq/client";
import fs from "fs-extra";

// === Notion ===
const notion = new Client({ auth: process.env.NOTION_TOKEN });
const DB_ID = process.env.NOTION_SEMINAR_DB_ID;

// === 출력 경로 ===
const OUT_PATH = "_data/seminar.json";

// === (필요 시 여기만 바꾸면 DB 속성명 매핑 가능) ===
const F = {
  title: "Title",
  date: "Date",
  presenter: "Presenter",
  published: "Published",
};

// ---- helpers ----
const getText = (prop) => {
  if (!prop) return "";
  const t = prop[prop.type];
  if (prop.type === "title" || prop.type === "rich_text") {
    return (t || []).map(x => x.plain_text).join("").trim();
  }
  if (prop.type === "select") return t?.name || "";
  if (prop.type === "multi_select") return (t || []).map(x => x.name).join(", ");
  if (prop.type === "people") return (t || []).map(x => x.name || x.person?.email).join(", ");
  return "";
};
const getDate = (prop) => prop?.date?.start || "";
const notionUrl = (pageId) => `https://www.notion.so/${pageId.replace(/-/g, "")}`;

async function fetchAll() {
  const rows = [];
  let cursor;
  while (true) {
    const resp = await notion.databases.query({
      database_id: DB_ID,
      filter: { property: F.published, checkbox: { equals: true } },
      start_cursor: cursor
    });
    rows.push(...resp.results);
    if (!resp.has_more) break;
    cursor = resp.next_cursor;
  }
  return rows;
}

(async () => {
  try {
    const pages = await fetchAll();

    const items = pages.map(p => {
      const props = p.properties;
      return {
        date: getDate(props[F.date]),
        title: getText(props[F.title]) || "Untitled",
        presenter: getText(props[F.presenter]) || "",
        notion_url: notionUrl(p.id),
      };
    })
    .filter(x => x.date)
    .sort((a, b) => (a.date < b.date ? 1 : -1)); // 최신순

    await fs.ensureDir("_data");
    await fs.writeJson(OUT_PATH, items, { spaces: 2 });
    console.log(`Wrote ${items.length} items → ${OUT_PATH}`);
  } catch (e) {
    console.error("Sync error:", e?.body || e?.message || e);
    process.exit(1);
  }
})();
